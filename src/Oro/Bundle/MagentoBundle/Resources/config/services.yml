services:
    oro_magento.transport.soap_transport:
        class: Oro\Bundle\MagentoBundle\Provider\Transport\SoapTransport
        arguments:
            - "@oro_security.encoder.default"
            - "@oro_magento.wsdl_manager"
            - "@oro_magento.provider.soap.unique_customer_email"
            - []
        tags:
            - { name: oro_integration.transport, type: magento_soap, channel_type: magento }
            - { name: oro_magento.bundle_config.aware, argument_number: 3 }
        calls:
            - [setLogger, ["@oro_integration.logger.strategy"]]

    oro_magento.transport.rest_transport:
        class: Oro\Bundle\MagentoBundle\Provider\Transport\RestTransport
        public: true
        arguments:
            - '@oro_integration.transport.rest.event_dispatchable_client_factory'
            - '@oro_magento.provider.rest_token_provider'
            - '@oro_magento.transport.provider.oro_bridge_extension_config_provider'
            - '@oro_magento.converter.rest.response_converter_manager'
        calls:
            - [setLogger, ["@oro_integration.logger.strategy"]]
        tags:
            - { name: oro_integration.transport, type: magento_rest, channel_type: magento2 }

    oro_magento.transport.provider.oro_bridge_extension_config_provider:
        class: Oro\Bundle\MagentoBundle\Provider\Transport\Provider\OroBridgeExtensionConfigProvider

    # Providers
# Magento integration is disabled in CRM-9202
#    oro_magento.provider.magento_channel_type:
#        class: Oro\Bundle\MagentoBundle\Provider\MagentoChannelType
#        tags:
#            - { name: oro_integration.channel, type: magento }

    oro_magento.provider.cart_expiration_processor:
        class: Oro\Bundle\MagentoBundle\Provider\CartExpirationProcessor
        arguments:
            - "@oro_integration.provider.connector_context_mediator"
            - "@doctrine.orm.entity_manager"

    oro_magento.provider.tracking_visit:
        class: Oro\Bundle\MagentoBundle\Provider\TrackingVisitProvider
        arguments:
            - "@doctrine"
            - "@oro_security.acl_helper"

    oro_magento.provider.tracking_visit_event:
        class: Oro\Bundle\MagentoBundle\Provider\TrackingVisitEventProvider
        arguments:
            - "@doctrine"

    oro_magento.provider.website_metrics:
        class: Oro\Bundle\MagentoBundle\Provider\WebsiteMetricsProvider
        public: true
        arguments:
            - '@oro_magento.provider.tracking_visit'
            - '@oro_magento.provider.tracking_visit_event'

    oro_magento.provider.website_chart:
        abstract: true
        arguments:
            - '@oro_magento.provider.tracking_visit_event'
            - '@oro_chart.config_provider'
            - '@oro_chart.view_builder'
            - '@translator'

    oro_magento.provider.website_events_chart:
        class: Oro\Bundle\MagentoBundle\Provider\WebsiteEventsChartProvider
        public: true
        parent: oro_magento.provider.website_chart

    oro_magento.provider.website_channel_chart:
        class: Oro\Bundle\MagentoBundle\Provider\WebsiteChannelChartProvider
        public: true
        parent: oro_magento.provider.website_chart

    oro_magento.provider.rest_token_provider:
        class: Oro\Bundle\MagentoBundle\Provider\RestTokenProvider
        arguments:
            - '@doctrine'
            - '@oro_security.encoder.default'
        calls:
            - [setLogger, ["@oro_integration.logger.strategy"]]

    oro_magento.provider.soap.unique_customer_email:
        class: Oro\Bundle\MagentoBundle\Provider\UniqueCustomerEmailSoapProvider

    # forms
    oro_magento.form.subscriber.transport_setting:
        class: Oro\Bundle\MagentoBundle\Form\EventListener\SettingsFormSubscriber
        arguments:
            - "@oro_security.encoder.default"

    oro_magento.form.type.soap_transport_setting:
        class: Oro\Bundle\MagentoBundle\Form\Type\SoapTransportSettingFormType
        arguments:
            - "@oro_magento.transport.soap_transport"
            - "@oro_magento.form.subscriber.transport_setting"
            - "@oro_integration.manager.types_registry"
        tags:
            - { name: form.type, alias: oro_magento_soap_transport_setting_form_type }

    oro_magento.form.type.rest_transport_setting:
        class: Oro\Bundle\MagentoBundle\Form\Type\RestTransportSettingFormType
        arguments:
            - "@oro_magento.transport.rest_transport"
            - "@oro_magento.form.subscriber.transport_setting"
            - "@oro_integration.manager.types_registry"
        tags:
            - { name: form.type, alias: oro_magento_rest_transport_setting_form_type }

    oro_magento.form.type.shared_guest_email_list:
        class: Oro\Bundle\MagentoBundle\Form\Type\SharedGuestEmailListType
        tags:
           - { name: form.type, alias: oro_magento_shared_guest_email_list_type }

    oro_magento.form.type.is_display_order_notes:
        class: Oro\Bundle\MagentoBundle\Form\Type\IsDisplayOrderNotesFormType
        tags:
           - { name: form.type, alias: oro_magento_is_display_order_notes_type }

    oro_magento.form.type.transport_check:
        class: Oro\Bundle\MagentoBundle\Form\Type\TransportCheckButtonType
        tags:
            - { name: form.type, alias: oro_magento_transport_check_button }

    oro_magento.form.type.order_select:
        class: Oro\Bundle\MagentoBundle\Form\Type\OrderSelectType
        tags:
            - { name: form.type, alias: oro_order_select }

    oro_magento.form.type.customer_select:
        class: Oro\Bundle\MagentoBundle\Form\Type\CustomerSelectType
        tags:
            - { name: form.type, alias: oro_customer_select }

    oro_magento.form.type.cart_select:
        class: Oro\Bundle\MagentoBundle\Form\Type\CartSelectType
        tags:
            - { name: form.type, alias: oro_cart_select }

    oro_magento.form.type.website_select:
        class: Oro\Bundle\MagentoBundle\Form\Type\WebsiteSelectType
        tags:
            - { name: form.type, alias: oro_magento_website_select }

    oro_magento.form.type.order_place:
        class: Oro\Bundle\MagentoBundle\Form\Type\OrderPlaceType
        tags:
            - { name: form.type, alias: oro_magento_order_place_form_type }

    oro_magento.form.type.customer:
        class: Oro\Bundle\MagentoBundle\Form\Type\CustomerType
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Customer'
            - 'Oro\Bundle\MagentoBundle\Entity\Address'
        tags:
            - { name: form.type, alias: oro_magento_customer }

    oro_magento.form.type.customer_address:
        class: Oro\Bundle\MagentoBundle\Form\Type\CustomerAddressType
        tags:
            - { name: form.type, alias: oro_magento_customer_addresses }

    oro_magento.form.type.customer_group_selector:
        class: Oro\Bundle\MagentoBundle\Form\Type\CustomerGroupSelectType
        arguments:
            - '@security.authorization_checker'
        tags:
            - { name: form.type, alias: oro_magento_customer_group_select }

    oro_magento.form.type.store_selector:
        class: Oro\Bundle\MagentoBundle\Form\Type\StoreSelectType
        tags:
            - { name: form.type, alias: oro_magento_store_select }

    oro_magento.form.type.customer_channel_selector:
        class: Oro\Bundle\MagentoBundle\Form\Type\CustomerChannelSelectType
        arguments:
            - '@oro_channel.provider.channels_by_entities'
        calls:
            - [setChannelClass, ['Oro\Bundle\ChannelBundle\Entity\Channel']]
        tags:
            - { name: form.type, alias: oro_magento_customer_channel_select }

    oro_magento.form.handler.customer:
        class: Oro\Bundle\MagentoBundle\Form\Handler\CustomerHandler
        parent: oro_form.model.update_handler
        calls:
            - [setStateHandler,  ["@oro_magento.customer_state_handler"]]

    Oro\Bundle\MagentoBundle\Form\Handler\CustomerHandler:
        alias: oro_magento.form.handler.customer

    oro_magento.form.cart.api:
        class: Symfony\Component\Form\Form
        public: true
        factory: ['@form.factory', createNamed]
        arguments:
            - ~
            - Oro\Bundle\MagentoBundle\Form\Type\CartApiType

    oro_magento.form.type.cart.api:
        class: Oro\Bundle\MagentoBundle\Form\Type\CartApiType
        tags:
            - { name: form.type, alias: cart_api_type }

    oro_magento.form.type.cart_item_collection:
        class: Oro\Bundle\MagentoBundle\Form\Type\CartItemCollectionType
        tags:
             - { name: form.type, alias: oro_cart_item_collection }

    oro_magento.form.cart_item.api:
        class: Symfony\Component\Form\Form
        public: true
        factory: ['@form.factory', createNamed]
        arguments:
            - ~
            - Oro\Bundle\MagentoBundle\Form\Type\CartItemsApiType

    oro_magento.form.type.cart_item.api:
        class: Oro\Bundle\MagentoBundle\Form\Type\CartItemsApiType
        tags:
            - { name: form.type, alias: cart_item_api_type }

    oro_magento.form.cart_address.api:
        class: Symfony\Component\Form\Form
        public: true
        factory: ['@form.factory', createNamed]
        arguments:
            - ~
            - Oro\Bundle\MagentoBundle\Form\Type\CartAddressApiType

    oro_magento.form.type.cart_address:
        class: Oro\Bundle\MagentoBundle\Form\Type\CartAddressApiType
        tags:
             - { name: form.type, alias: cart_address_api_type }

    oro_magento.form.order.api:
        class: Symfony\Component\Form\Form
        public: true
        factory: ['@form.factory', createNamed]
        arguments:
            - ~
            - Oro\Bundle\MagentoBundle\Form\Type\OrderApiType

    oro_magento.form.type.order.api:
        class: Oro\Bundle\MagentoBundle\Form\Type\OrderApiType
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Order'
        tags:
            - { name: form.type, alias: order_api_type }

    oro_magento.form.type.order_item_collection:
        class: Oro\Bundle\MagentoBundle\Form\Type\OrderItemCollectionType
        tags:
             - { name: form.type, alias: oro_order_item_collection }

    oro_magento.form.type.order_item:
        class: Oro\Bundle\MagentoBundle\Form\Type\OrderItemType
        tags:
             - { name: form.type, alias: oro_order_item }

    oro_magento.form.type.order_address.api:
        class: Oro\Bundle\MagentoBundle\Form\Type\OrderAddressApiType
        tags:
            - { name: form.type, alias: order_address_api_type }

    oro_magento.form.order_address.api:
        class: Symfony\Component\Form\Form
        public: true
        factory: ['@form.factory', createNamed]
        arguments:
            - ~
            - Oro\Bundle\MagentoBundle\Form\Type\OrderAddressApiType

    oro_magento.form.type.order_item.api:
        class: Oro\Bundle\MagentoBundle\Form\Type\OrderItemsApiType
        tags:
            - { name: form.type, alias: order_item_api_type }

    oro_magento.form.order_item.api:
        class: Symfony\Component\Form\Form
        public: true
        factory: ['@form.factory', createNamed]
        arguments:
            - ~
            - Oro\Bundle\MagentoBundle\Form\Type\OrderItemsApiType

    oro_magento.form.type.customer.api:
        class: Oro\Bundle\MagentoBundle\Form\Type\CustomerApiType
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Customer'
        tags:
            - { name: form.type, alias: api_customer_type }

    oro_magento.form.customer.api:
        class: Symfony\Component\Form\Form
        public: true
        factory: ['@form.factory', createNamed]
        arguments:
            - ~
            - Oro\Bundle\MagentoBundle\Form\Type\CustomerApiType

    oro_magento.form.customer_address.api:
        class: Symfony\Component\Form\Form
        public: true
        factory: ['@form.factory', createNamed]
        arguments:
            - ~
            - Oro\Bundle\MagentoBundle\Form\Type\CustomerAddressApiType

    oro_magento.form.type.customer_address.api:
        class: Oro\Bundle\MagentoBundle\Form\Type\CustomerAddressApiType
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Customer'
        tags:
            - { name: form.type, alias: customer_address_api_type }

    # Search handler
    oro_magento.form.autocomplete.order.search_handler:
        parent: oro_form.autocomplete.search_handler
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Order'
            - ["incrementId"]
        tags:
            - { name: oro_form.autocomplete.search_handler, alias: oro_magento.orders, acl_resource: oro_magento_order_view }
        lazy: true

    oro_magento.form.autocomplete.customer.search_handler:
        parent: oro_form.autocomplete.full_name.search_handler
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Customer'
            - ["namePrefix", "firstName", "middleName", "lastName", "nameSuffix"]
        tags:
            - { name: oro_form.autocomplete.search_handler, alias: oro_magento.customers, acl_resource: oro_magento_customer_view }
        lazy: true

    oro_magento.form.autocomplete.cart.search_handler:
        parent: oro_form.autocomplete.search_handler
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Cart'
            - ["originId"]
        tags:
            - { name: oro_form.autocomplete.search_handler, alias: oro_magento.carts, acl_resource: oro_magento_cart_view }
        lazy: true

    # event listeners
    oro_magento.event_listener.order_grid:
        class: Oro\Bundle\MagentoBundle\EventListener\OrderGridListener
        arguments:
            - "@oro_magento.country.datagrid_helper"
            - '@oro_filter.provider.state.filters'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.before.magento-order-grid, method: onBuildBefore }

    oro_magento.event_listener.customer_currency:
        class: Oro\Bundle\MagentoBundle\EventListener\CustomerCurrencyListener
        arguments:
            - '@oro_locale.settings'
        tags:
            - { name: doctrine.orm.entity_listener, entity: 'Oro\Bundle\MagentoBundle\Entity\Customer', event: prePersist }

    oro_magento.event_listener.order:
        class: Oro\Bundle\MagentoBundle\EventListener\OrderListener
        arguments:
            - "@oro_channel.event_listener.doctrine"
        tags:
            - { name: doctrine.orm.entity_listener, entity: 'Oro\Bundle\MagentoBundle\Entity\Order', event: prePersist }
            - { name: doctrine.orm.entity_listener, entity: 'Oro\Bundle\MagentoBundle\Entity\Order', event: preUpdate }
            - { name: doctrine.event_listener, event: postFlush, priority: 5 }

    oro_magento.event_listener.customer_order_grid_listener:
        class: Oro\Bundle\MagentoBundle\EventListener\AccountWidgetsDataGridListener
        arguments:
            - ['customerId', 'channelId']
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.magento-customer-order-grid, method: onBuildAfter }
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.magento-customer-cart-grid, method: onBuildAfter }
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.magento-customer-orders-widget-grid, method: onBuildAfter }
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.magento-customer-cart-widget-grid, method: onBuildAfter }
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.magento-customer-recent-purchases-widget-grid, method: onBuildAfter }
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.magento-customer-recent-purchases-grid, method: onBuildAfter }

    oro_magento.event_listener.channel_owner_set:
        class: Oro\Bundle\MagentoBundle\EventListener\ChannelOwnerSetListener
        arguments:
            - "@doctrine.orm.default_entity_manager"
        tags:
            - { name: kernel.event_listener, event: oro_integration.default_owner.set, method: onSet }

    oro_magento.event_listener.customer_group_grid_listener:
        class: Oro\Bundle\MagentoBundle\EventListener\CustomerGroupGridListener
        arguments:
            - '@security.authorization_checker'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.magento-customers-group-by-channel-grid, method: onBuildAfter }

    oro_magento.event_listener.store_grid_listener:
        class: Oro\Bundle\MagentoBundle\EventListener\StoreGridListener
        arguments:
            - '@security.authorization_checker'
            - 'Oro\Bundle\ChannelBundle\Entity\Channel'
            - '@doctrine.orm.entity_manager'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.magento-store-by-channel-grid, method: onBuildAfter }

    oro_magento.event_listener.update_integration_connectors:
        class: Oro\Bundle\MagentoBundle\EventListener\UpdateIntegrationConnectorsListener
        arguments:
            - "@oro_channel.provider.settings_provider"
            - "@doctrine"
        calls:
            - [setConnectorsTypeRegistry,  ["@oro_integration.manager.types_registry"]]
        tags:
            - { name: kernel.event_listener, event: oro_channel.channel.save_succeed, method: onChannelSave, priority: -10 }

    oro_magento.event_listener.writer_error:
        class: Oro\Bundle\MagentoBundle\EventListener\IntegrationWriteErrorListener
        tags:
            - { name: kernel.event_listener, event: oro_integration.writer_error, method: handleError }

    # This listener implement OptionalListenerInterface and should be enabled manualy
    # Logic extend search IndexListener so when you enable this listener you should disable `oro_search.index_listener`
    # to prevent message queue duplicated jobs
    oro_magento.event_listener.delayed_search_reindex:
        class: Oro\Bundle\MagentoBundle\EventListener\SearchIndexListener
        parent: oro_search.index_listener
        calls:
            - [setEnabled, [false]]
        tags:
            - { name: doctrine.event_listener, event: onFlush }
            - { name: doctrine.event_listener, event: postFlush }
            - { name: doctrine.event_listener, event: onClear }
            - { name: kernel.event_listener, event: oro_integration.event.sync_after, method: onFinish }

    # This listener implemented to enable/disable oro_magento.event_listener.delayed_search_reindex
    # for Magento integration only
    oro_magento.event_listener.alternative_search_index_switcher:
        class: Oro\Bundle\MagentoBundle\EventListener\AlternativeSearchIndexSwitcherListener
        arguments:
            - '@oro_platform.optional_listeners.manager'
        tags:
            - { name: kernel.event_listener, event: oro_integration.event.sync_before, method: onStart }
            - { name: kernel.event_listener, event: oro_integration.event.sync_after, method: onFinish }

    oro_magento.migration.demo_data_fixtures_listener.search_index:
        class: Oro\Bundle\MagentoBundle\EventListener\SearchIndexDemoDataFixturesListener
        arguments:
            - '@oro_platform.optional_listeners.manager'
        tags:
            - { name: kernel.event_listener, event: oro_migration.data_fixtures.pre_load, method: onPreLoad }
            - { name: kernel.event_listener, event: oro_migration.data_fixtures.post_load, method: onPostLoad }

    oro_magento.service.magento_url_generator:
        class: Oro\Bundle\MagentoBundle\Service\MagentoUrlGenerator
        arguments:
            - "@router"
        shared: false

    oro_magento.event_listener.after_job_execution:
        class: Oro\Bundle\MagentoBundle\EventListener\IntegrationSyncAfterEventListener
        tags:
            - { name: kernel.event_listener, event: oro_integration.event.sync_after, method: process }

    oro_magento.event_listener.customer_datagrid_listener:
        class: Oro\Bundle\MagentoBundle\EventListener\CustomerDataGridListener
        arguments:
            - '@oro_datagrid.provider.selected_fields.filters'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.pre.magento-customers-grid, method: onPreBuild, priority: 255 }

    oro_magento.event_listener.account_view:
        class: Oro\Bundle\MagentoBundle\EventListener\AccountViewListener
        arguments:
            - '@oro_entity.doctrine_helper'
            - '@request_stack'
            - '@oro_sales.customer.config_provider'
            - '@oro_sales.manager.account_customer'
            - 'Oro\Bundle\MagentoBundle\Entity\Customer'
        tags:
            - { name: kernel.event_listener, event: oro_ui.scroll_data.before.magentoCustomerView, method: onView }

    Oro\Bundle\MagentoBundle\EventListener\CollectAccountWebsiteActivityCustomersListener:
        arguments:
            - '@doctrine'
        tags:
            - { name: kernel.event_listener, event: Oro\Bundle\AccountBundle\Event\CollectAccountWebsiteActivityCustomersEvent, method: onAccountView }

    # Customer API
    oro_magento.customer_address.manager.api:
        class: Oro\Bundle\MagentoBundle\Entity\Manager\CustomerAddressApiEntityManager
        public: true
        parent: oro_soap.manager.entity_manager.abstract
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Address'
            - "@doctrine.orm.entity_manager"

    oro_magento.customer.manager.api:
        class: Oro\Bundle\MagentoBundle\Entity\Manager\CustomerApiEntityManager
        public: true
        parent: oro_soap.manager.entity_manager.abstract
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Customer'
            - "@doctrine.orm.entity_manager"

    oro_magento.customer_birthday_type_transformer:
        class: Oro\Bundle\MagentoBundle\Form\DataTransformer\BirthdayTypeApiTransformer
        public: true

    oro_magento.datagrid_helper:
        class: Oro\Bundle\MagentoBundle\Datagrid\MagentoDatagridHelper
        public: true
        arguments:
            - '@doctrine.orm.entity_manager'
            - '@oro_security.acl_helper'

    oro_magento.country.datagrid_helper:
        class: Oro\Bundle\AddressBundle\Datagrid\CountryDatagridHelper
        public: true

    oro_magento.manager.magento_delete_provider:
        class: Oro\Bundle\MagentoBundle\Manager\MagentoDeleteProvider
        arguments:
            - "@doctrine.orm.entity_manager"
        tags:
            - { name: oro_integration.delete_provider }

    oro_magento.manager.customer_address_manager:
        class: Oro\Bundle\MagentoBundle\Manager\CustomerAddressManager
        arguments:
            - "@doctrine.orm.entity_manager"
        calls:
            - ['setLogger',  ["@logger"]]

    oro_magento.manager.customer_contact_manager:
        class: Oro\Bundle\MagentoBundle\Manager\CustomerContactManager
        arguments:
            - "@doctrine.orm.entity_manager"
            - "@oro_workflow.listener.extension.process_trigger"
        calls:
            - ['setLogger',  ["@logger"]]

    oro_magento.importexport.address_import_helper:
        class: Oro\Bundle\MagentoBundle\ImportExport\Strategy\StrategyHelper\AddressImportHelper
        arguments:
            - "@oro_magento.importexport.doctrine_helper"

    oro_magento.importexport.guest_customer_strategy_helper:
        public: false
        class: Oro\Bundle\MagentoBundle\ImportExport\Strategy\StrategyHelper\GuestCustomerStrategyHelper
        arguments:
            - '@oro_importexport.field.database_helper'

    oro_magento.importexport.doctrine_helper:
        class: Oro\Bundle\MagentoBundle\ImportExport\Strategy\StrategyHelper\DoctrineHelper
        arguments:
            - "@oro_importexport.strategy.import.helper"

    oro_magento.dashboard.data_provider.order:
        class: Oro\Bundle\MagentoBundle\Dashboard\OrderDataProvider
        arguments:
            - "@doctrine"
            - "@oro_security.acl_helper"
            - "@oro_chart.config_provider"
            - "@oro_locale.formatter.date_time"
            - "@oro_dashboard.datetime.helper"

    Oro\Bundle\MagentoBundle\Dashboard\OrderDataProvider:
        alias: oro_magento.dashboard.data_provider.order

    oro_magento.dashboard.data_provider.customer:
        class: Oro\Bundle\MagentoBundle\Dashboard\CustomerDataProvider
        arguments:
            - '@doctrine'
            - '@oro_security.acl_helper'
            - '@oro_chart.config_provider'
            - '@oro_dashboard.datetime.helper'

    Oro\Bundle\MagentoBundle\Dashboard\CustomerDataProvider:
        alias: oro_magento.dashboard.data_provider.customer

    oro_magento.dashboard.data_provider.purchase:
        class: Oro\Bundle\MagentoBundle\Dashboard\PurchaseDataProvider
        arguments:
            - '@doctrine'
            - '@oro_chart.config_provider'
            - '@oro_magento.provider.tracking_visit'
            - '@translator'
            - '@oro_security.acl_helper'
            - '@oro_dashboard.filter.date_filter_processor'

    Oro\Bundle\MagentoBundle\Dashboard\PurchaseDataProvider:
        alias: oro_magento.dashboard.data_provider.purchase

    oro_magento.placeholder.filter:
        class: Oro\Bundle\MagentoBundle\Placeholder\PlaceholderFilter
        public: true

    oro_magento.provider.enitity_state:
        parent: oro_channel.provider.utils.entity_state_provider
        public: true
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity'

    oro_magento.provider.phone.address:
        class: Oro\Bundle\MagentoBundle\Provider\AddressPhoneProvider
        tags:
            - { name: oro_address.phone_provider, class: 'Oro\Bundle\MagentoBundle\Entity\Address' }

    oro_magento.provider.phone.cart_address:
        class: Oro\Bundle\MagentoBundle\Provider\CartAddressPhoneProvider
        tags:
            - { name: oro_address.phone_provider, class: 'Oro\Bundle\MagentoBundle\Entity\CartAddress' }

    oro_magento.provider.phone.order_address:
        class: Oro\Bundle\MagentoBundle\Provider\OrderAddressPhoneProvider
        tags:
            - { name: oro_address.phone_provider, class: 'Oro\Bundle\MagentoBundle\Entity\OrderAddress' }

    oro_magento.provider.phone.customer:
        class: Oro\Bundle\MagentoBundle\Provider\CustomerPhoneProvider
        tags:
            - { name: oro_address.phone_provider, class: 'Oro\Bundle\MagentoBundle\Entity\Customer' }

    oro_magento.provider.analytics.customer_recency:
        class: Oro\Bundle\MagentoBundle\Provider\Analytics\CustomerRecencyProvider
        arguments:
            - "@oro_entity.doctrine_helper"
            - "@oro_channel.provider.settings_provider"
            - 'Oro\Bundle\MagentoBundle\Entity\Customer'
        tags:
            - { name: oro_analytics.builder.rfm }

    oro_magento.provider.analytics.customer_frequency:
        class: Oro\Bundle\MagentoBundle\Provider\Analytics\CustomerFrequencyProvider
        arguments:
            - "@oro_entity.doctrine_helper"
            - "@oro_channel.provider.settings_provider"
            - 'Oro\Bundle\MagentoBundle\Entity\Customer'
        tags:
            - { name: oro_analytics.builder.rfm }

    oro_magento.provider.analytics.customer_monetary:
        class: Oro\Bundle\MagentoBundle\Provider\Analytics\CustomerMonetaryProvider
        arguments:
            - "@oro_entity.doctrine_helper"
            - "@oro_channel.provider.settings_provider"
            - 'Oro\Bundle\MagentoBundle\Entity\Customer'
        tags:
            - { name: oro_analytics.builder.rfm }

    # Search handlers
    oro_magento.form.autocomplete.customer_group.search_handler:
        class: Oro\Bundle\MagentoBundle\Autocomplete\CustomerGroupSearchHandler
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\CustomerGroup'
            - ["name"]
        calls:
            - [initDoctrinePropertiesByManagerRegistry,  ["@doctrine"]]
            - [setAclHelper,["@oro_security.acl_helper"]]
            - [setDataChannelClass, ['Oro\Bundle\ChannelBundle\Entity\Channel']]
            - [setAuthorizationChecker, ['@security.authorization_checker']]
        tags:
            - { name: oro_form.autocomplete.search_handler, alias: "magento_customer_group", acl_resource: "oro_magento_customer_view" }

    oro_magento.form.autocomplete.store.search_handler:
        class: Oro\Bundle\MagentoBundle\Autocomplete\StoreSearchHandler
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Store'
            - ["name"]
        calls:
            - [initDoctrinePropertiesByManagerRegistry,  ["@doctrine"]]
            - [setAclHelper,["@oro_security.acl_helper"]]
            - [setDataChannelClass, ['Oro\Bundle\ChannelBundle\Entity\Channel']]
            - [setAuthorizationChecker, ['@security.authorization_checker']]
        tags:
            - { name: oro_form.autocomplete.search_handler, alias: "magento_store", acl_resource: "oro_magento_customer_view" }

    oro_magento.validator.unique_customer_email:
        class: Oro\Bundle\MagentoBundle\Validator\UniqueCustomerEmailValidator
        arguments:
            - '@oro_integration.manager.types_registry'
        tags:
            - { name: validator.constraint_validator, alias: oro_magento.validator.unique_customer_email }

    oro_magento.validator.email_address_list:
        class: Oro\Bundle\MagentoBundle\Validator\EmailAddressListValidator
        tags:
            - { name: validator.constraint_validator, alias: oro_magento.validator.email_address_list }

    oro_magento.validator.start_sync_date:
        class: Oro\Bundle\MagentoBundle\Validator\StartSyncDateValidator
        arguments:
            - "@doctrine"
        tags:
            - { name: validator.constraint_validator, alias: oro_magento.validator.start_sync_date }

    oro_magento.security.acl.voter.two_way_sync:
        class: Oro\Bundle\MagentoBundle\Acl\Voter\AbstractTwoWaySyncVoter
        abstract: true
        arguments:
            - "@oro_entity.doctrine_helper"
        calls:
            - [setSettingsProvider,  ["@oro_magento.model.channel_settings_provider"]]

    oro_magento.security.acl.voter.customer:
        class: Oro\Bundle\MagentoBundle\Acl\Voter\CustomerVoter
        parent: oro_magento.security.acl.voter.two_way_sync
        calls:
            - [setClassName, ['Oro\Bundle\MagentoBundle\Entity\Customer']]
        tags:
            - { name: security.voter, priority: 500 }

    oro_magento.security.acl.voter.newletter_subscriber:
        class: Oro\Bundle\MagentoBundle\Acl\Voter\NewsletterSubscriberVoter
        parent: oro_magento.security.acl.voter.two_way_sync
        calls:
            - [setClassName, ['Oro\Bundle\MagentoBundle\Entity\NewsletterSubscriber']]
        tags:
            - { name: security.voter, priority: 500 }

    oro_magento.security.acl.voter.organization:
        class: Oro\Bundle\MagentoBundle\Acl\Voter\OrganizationAnnotationVoter
        parent: oro_magento.security.acl.voter.two_way_sync
        calls:
            - [setClassName, ['Oro\Bundle\OrganizationBundle\Entity\Organization']]
        tags:
            - { name: security.voter, priority: 600 }

    oro_magento.datagrid.customer_actions_provider:
        class: Oro\Bundle\MagentoBundle\Datagrid\CustomerActionPermissionProvider
        public: true
        parent: oro_magento.datagrid.newsletter_subscriber_provider
        arguments:
            - "@oro_magento.model.channel_settings_provider"

    oro_magento.state_manager:
        class: Oro\Bundle\MagentoBundle\Service\StateManager

    oro_magento.customer_state_handler:
        class: Oro\Bundle\MagentoBundle\Service\CustomerStateHandler
        arguments:
            - "@oro_magento.state_manager"

    oro_magento.datagrid.newsletter_subscriber_provider:
        class: Oro\Bundle\MagentoBundle\Datagrid\NewsletterSubscriberPermissionProvider
        public: true
        arguments:
            - "@oro_magento.model.channel_settings_provider"
        calls:
            - [setAuthorizationChecker,  ["@security.authorization_checker"]]

    oro_magento.model.newsletter_subscriber_manager:
        class: Oro\Bundle\MagentoBundle\Model\NewsletterSubscriberManager
        arguments:
            - "@oro_entity.doctrine_helper"

    Oro\Bundle\MagentoBundle\Model\NewsletterSubscriberManager:
        alias: oro_magento.model.newsletter_subscriber_manager

    oro_magento.strategy.automatic_discovery.default:
        class: Oro\Bundle\MagentoBundle\Service\AutomaticDiscovery\DefaultDiscoveryStrategy

    oro_magento.strategy.automatic_discovery.addresses:
        class: Oro\Bundle\MagentoBundle\Service\AutomaticDiscovery\AddressDiscoveryStrategy

    oro_magento.strategy.automatic_discovery.email:
        class: Oro\Bundle\MagentoBundle\Service\AutomaticDiscovery\EmailDiscoveryStrategy

    oro_magento.service.automatic_discovery:
        class: Oro\Bundle\MagentoBundle\Service\AutomaticDiscovery
        arguments:
            - "@oro_entity.doctrine_helper"
            - "@oro_magento.strategy.automatic_discovery.default"
            - "@oro_security.owner.ownership_metadata_provider"
            - 'Oro\Bundle\MagentoBundle\Entity\Customer'
            - []
        calls:
            - [addStrategy, ['addresses', "@oro_magento.strategy.automatic_discovery.addresses"]]
            - [addStrategy, ['email', "@oro_magento.strategy.automatic_discovery.email"]]
        tags:
            - { name: oro_magento.bundle_config.aware, argument_number: 4 }

    oro_magento.action.automatic_discovery:
        class: Oro\Bundle\MagentoBundle\Model\Action\AutomaticDiscoveryAction
        arguments:
            - "@oro_action.expression.context_accessor"
            - "@oro_magento.service.automatic_discovery"
        tags:
            - { name: oro_action.action, alias: automatic_discovery }

    oro_magento.wsdl.guzzle_client:
        class: Guzzle\Http\Client
        lazy: true

    oro_magento.wsdl_manager:
        class: Oro\Bundle\MagentoBundle\Service\WsdlManager
        arguments:
            - "@filesystem"
            - "@oro_magento.wsdl.guzzle_client"
            - '%kernel.cache_dir%'
            - []
        tags:
            - { name: oro_magento.bundle_config.aware, argument_number: 3 }

    oro_magento.wsdl.cache_clearer:
        public: false
        class: Oro\Bundle\MagentoBundle\Cache\WsdlCacheClearer
        arguments:
            - "@oro_magento.wsdl_manager"
        tags:
            - { name: kernel.cache_clearer,  priority: 30 }

    oro_magento.integration_entity.remove_listener:
        class: Oro\Bundle\MagentoBundle\EventListener\IntegrationRemoveListener
        arguments:
            - "@oro_magento.wsdl_manager"
        tags:
            - { name: doctrine.orm.entity_listener, entity: Oro\Bundle\MagentoBundle\Entity\MagentoSoapTransport, event: preRemove }

    oro_magento.model.channel_settings_provider:
        class: Oro\Bundle\MagentoBundle\Model\ChannelSettingsProvider
        arguments:
            - "@oro_entity.doctrine_helper"
            - 'Oro\Bundle\IntegrationBundle\Entity\Channel'

    oro_magento.provider.big_number:
        class: Oro\Bundle\MagentoBundle\Provider\MagentoBigNumberProvider
        arguments:
            - "@doctrine"
            - "@oro_security.acl_helper"
            - "@oro_dashboard.provider.big_number.date_helper"
            - "@oro_magento.provider.website_visit"
        tags:
            - { name: oro_dashboard.big_number.provider, alias: magento }

    oro_magento.provider.website_visit:
        class: Oro\Bundle\MagentoBundle\Provider\WebsiteVisitProvider
        arguments:
            - "@doctrine"
            - "@oro_security.acl_helper"
            - "@oro_dashboard.provider.big_number.date_helper"

    oro_magento.service.order.information_loader:
        class: Oro\Bundle\MagentoBundle\Service\InformationLoader
        public: true
        arguments:
            - "@oro_importexport.job_executor"
            - "@oro_magento.mage.order_connector"
            - "oro_magento.add_or_update_order"

    oro_magento.service.cart.information_loader:
        class: Oro\Bundle\MagentoBundle\Service\InformationLoader
        public: true
        arguments:
            - "@oro_importexport.job_executor"
            - "@oro_magento.mage.cart_connector"
            - "oro_magento.add_or_update_cart"

    # manager
    oro_magento.cart.manager.api:
        class: Oro\Bundle\MagentoBundle\Entity\Manager\CartApiEntityManager
        public: true
        parent: oro_soap.manager.entity_manager.abstract
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Cart'
            - "@doctrine.orm.entity_manager"

    oro_magento.cart_address.manager.api:
        class: Oro\Bundle\MagentoBundle\Entity\Manager\CartAddressApiEntityManager
        public: true
        parent: oro_soap.manager.entity_manager.abstract
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\CartAddress'
            - "@doctrine.orm.entity_manager"

    oro_magento.cart_item.manager.api:
        class: Oro\Bundle\MagentoBundle\Entity\Manager\CartItemApiEntityManager
        public: true
        parent: oro_soap.manager.entity_manager.abstract
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\CartItem'
            - "@doctrine.orm.entity_manager"

    oro_magento.order.manager.api:
        class: Oro\Bundle\MagentoBundle\Entity\Manager\OrderApiEntityManager
        public: true
        parent: oro_soap.manager.entity_manager.abstract
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Order'
            - "@doctrine.orm.entity_manager"

    oro_magento.order_item.manager.api:
        class: Oro\Bundle\MagentoBundle\Entity\Manager\OrderItemApiEntityManager
        public: true
        parent: oro_soap.manager.entity_manager.abstract
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\OrderItem'
            - "@doctrine.orm.entity_manager"

    oro_magento.order_address.manager.api:
        class: Oro\Bundle\MagentoBundle\Entity\Manager\OrderAddressApiEntityManager
        public: true
        parent: oro_soap.manager.entity_manager.abstract
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\OrderAddress'
            - "@doctrine.orm.entity_manager"

    # handler
    oro_magento.form.handler.cart.api:
        class: Oro\Bundle\MagentoBundle\Form\Handler\CartHandler
        public: true
        arguments:
            - "@oro_magento.form.cart.api"
            - "@request_stack"
            - "@doctrine"
            - "@oro_security.token_accessor"

    oro_magento.form.handler.cart_address:
        class: Oro\Bundle\MagentoBundle\Form\Handler\CartAddressHandler
        public: true
        arguments:
            - "@oro_magento.form.cart_address.api"
            - "@request_stack"
            - "@doctrine"
            - "@oro_security.token_accessor"

    oro_magento.form.handler.cart_item:
        class: Oro\Bundle\MagentoBundle\Form\Handler\CartItemHandler
        public: true
        arguments:
            - "@oro_magento.form.cart_item.api"
            - "@request_stack"
            - "@doctrine"

    oro_magento.form.handler.order.api:
        class: Oro\Bundle\MagentoBundle\Form\Handler\OrderHandler
        public: true
        arguments:
            - "@oro_magento.form.order.api"
            - "@request_stack"
            - "@doctrine"
            - "@oro_security.token_accessor"

    oro_magento.form.handler.order_item:
        class: Oro\Bundle\MagentoBundle\Form\Handler\OrderItemHandler
        public: true
        arguments:
            - "@oro_magento.form.order_item.api"
            - "@request_stack"
            - "@doctrine"

    oro_magento.form.handler.order_address.api:
        class: Oro\Bundle\MagentoBundle\Form\Handler\OrderAddressApiHandler
        public: true
        arguments:
            - "@oro_magento.form.order_address.api"
            - "@request_stack"
            - "@doctrine.orm.entity_manager"
            - "@oro_security.token_accessor"

    oro_magento.form.handler.customer.api:
        class: Oro\Bundle\MagentoBundle\Form\Handler\CustomerApiHandler
        public: true
        arguments:
            - "@oro_magento.form.customer.api"
            - "@request_stack"
            - "@doctrine"
            - "@oro_security.token_accessor"
            - "@oro_sales.manager.account_customer"

    oro_magento.form.api.handler.customer_address:
        class: Oro\Bundle\MagentoBundle\Form\Handler\CustomerAddressApiHandler
        public: true
        arguments:
            - "@oro_magento.form.customer_address.api"
            - "@request_stack"
            - "@doctrine"
            - "@oro_security.token_accessor"

    oro_magento.handler.transport:
        class: Oro\Bundle\MagentoBundle\Handler\TransportHandler
        public: true
        arguments:
            - '@oro_integration.manager.types_registry'
            - '@oro_magento.provider.transport_entity'
            - '@oro_magento.provider.website_choices'
            - '@oro_magento.provider.connector_choices'
            - '@request_stack'

    oro_magento.manager.abandoned_shopping_cart_flow:
        parent: oro_workflow.abstract.workflow_aware_manager
        calls:
            - ['setWorkflowName', ['b2c_flow_abandoned_shopping_cart']]

    Oro\Bundle\WorkflowBundle\Model\WorkflowAwareManager:
        alias: oro_magento.manager.abandoned_shopping_cart_flow

    oro_magento.async.sync_cart_expiration_integration_processor:
        class: Oro\Bundle\MagentoBundle\Async\SyncCartExpirationIntegrationProcessor
        arguments:
            - '@doctrine'
            - '@oro_magento.provider.cart_expiration_processor'
            - '@oro_message_queue.job.runner'
            - '@security.token_storage'
            - '@logger'
        tags:
            - { name: 'oro_message_queue.client.message_processor' }

    oro_magento.async.sync_initial_integration_processor:
        class: Oro\Bundle\MagentoBundle\Async\SyncInitialIntegrationProcessor
        arguments:
            - '@oro_entity.doctrine_helper'
            - '@oro_magento.provider.initial_sync_processor'
            - '@oro_platform.optional_listeners.manager'
            - '@oro_analytics.calculate_analytics_scheduler'
            - '@oro_message_queue.job.runner'
            - '@oro_search.async.indexer'
            - '@security.token_storage'
            - '@logger'
        tags:
            - { name: 'oro_message_queue.client.message_processor' }

    oro_magento.provider.customer.magento_customer_icon:
        class: Oro\Bundle\MagentoBundle\Provider\Customer\CustomerIconProvider
        arguments:
            - '@oro_integration.manager.types_registry'
            - '@liip_imagine.cache.manager'
        tags:
            - { name: oro_sales.customer_icon, priority: 10 }

    oro_magento.datagrid.cart_view_list:
        class: Oro\Bundle\MagentoBundle\Datagrid\CartViewList
        public: true
        arguments:
            - '@translator'

    oro_magento.customer_account_change_listener:
        class: Oro\Bundle\MagentoBundle\EventListener\CustomerAccountChangeListener
        tags:
            - { name: doctrine.event_listener, event: onFlush }
            - { name: doctrine.event_listener, event: postFlush }

    oro_magento.provider.customer.account:
        class: Oro\Bundle\MagentoBundle\Provider\Customer\AccountProvider
        arguments:
            - '@oro_magento.provider.customer.account.new_entities_helper'
            - '@oro_magento.service.automatic_discovery'
            - '@doctrine'
        public: false
        tags:
            - { name: oro_sales.provider.customer.account_creation, priority: 10 }

    oro_magento.provider.customer.account.new_entities_helper:
        class: Oro\Bundle\ImportExportBundle\Strategy\Import\NewEntitiesHelper
        tags:
            - { name: doctrine.event_listener, event: onFlush }
            - { name: doctrine.event_listener, event: onClear }

    oro_magento.customer.association_checker:
        class: Oro\Bundle\MagentoBundle\Customer\AssociationChecker
        arguments:
            - '@oro_sales.manager.account_customer'
            - '@oro_entity.doctrine_helper'

    oro_magento.provider.prepare_result_item_provider:
        class: Oro\Bundle\MagentoBundle\Provider\Customer\AccountAutocompleteProvider
        tags:
            - { name: oro_sales.provider.customer.account_autocomplete }

    oro_magento.converter.cart_subtotal_to_multicurrency:
        class: Oro\Bundle\MagentoBundle\Converter\CartSubtotalToMultiCurrency
        public: true

    oro_magento.provider.iso2_code:
        class: Oro\Bundle\MagentoBundle\Provider\Iso2CodeProvider
        arguments:
            - '@doctrine'

    oro_magento.provider.website_choices:
        class: Oro\Bundle\MagentoBundle\Provider\WebsiteChoicesProvider
        arguments:
            - '@translator'

    oro_magento.provider.connector_choices:
        class: Oro\Bundle\MagentoBundle\Provider\ConnectorChoicesProvider
        arguments:
            - '@oro_integration.manager.types_registry'
            - '@translator'

    oro_magento.provider.transport_entity:
        class: Oro\Bundle\MagentoBundle\Provider\TransportEntityProvider
        arguments:
            - '@form.factory'
            - '@doctrine'

    oro_magento.converter.rest.response_converter_manager:
        class: Oro\Bundle\MagentoBundle\Converter\Rest\ResponseConverterManager
        arguments:
            - ~ # service locator for response converters

    oro_magento.converter.rest.region_converter:
        class: Oro\Bundle\MagentoBundle\Converter\Rest\RegionConverter
        tags:
            - {name: oro_magento.rest_response.converter, type: region }

    oro_magento.converter.rest.website_converter:
        class: Oro\Bundle\MagentoBundle\Converter\Rest\WebsiteConverter
        tags:
            - {name: oro_magento.rest_response.converter, type: website }

    oro_magento.async.upgrade_relations_accounts_contacts_processor:
        class: Oro\Bundle\MagentoBundle\Migrations\Schema\v1_49\UpdateRelationsAccountsAndContactsProcessor
        arguments:
            - '@oro_message_queue.message_producer'
            - '@oro_entity.orm.native_query_executor_helper'
        tags:
            - { name: 'oro_message_queue.client.message_processor', topicName: !php/const Oro\Bundle\MagentoBundle\Migrations\Schema\v1_49\UpdateRelationsAccountsAndContactsTopic::NAME }

    oro_magento.async.schedule_stucked_jobs_processor:
        class: Oro\Bundle\MagentoBundle\Migrations\Schema\v1_50\ScheduleStuckedJobsProcessor
        arguments:
            - '@oro_message_queue.message_producer'
            - '@oro_entity.orm.native_query_executor_helper'
            - '@oro_workflow.process.logger'
        tags:
            - { name: 'oro_message_queue.client.message_processor', topicName: !php/const Oro\Bundle\MagentoBundle\Migrations\Schema\v1_50\ScheduleStuckedJobsTopic::NAME }

    oro_magento.twig.order_notes_extension:
        class: Oro\Bundle\MagentoBundle\Twig\OrderNotesExtension
        public: false
        tags:
            - { name: twig.extension }

    oro_magento.customer_virtual_relations.provider:
        class: Oro\Bundle\SalesBundle\Provider\CustomerAssignmentVirtualRelationProvider
        public: false
        arguments:
            - 'Oro\Bundle\MagentoBundle\Entity\Customer'
        tags:
           - { name: oro_entity.virtual_relation_provider, priority: 150 }
